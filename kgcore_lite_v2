<!doctype html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Qwello • KG Core Lite v2.5</title><style>:root{--bg:#0f1226;--panel:#141834;--ink:#e6e8ff;--muted:#a5a8d6;--brand:#8ea2ff;--brand2:#7ef0ff;--ok:#20d497;--warn:#ffbd4a;--bad:#ff6b6b;--edge:#364178}*{box-sizing:border-box}html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0e1022,#0b0f28 40%,#0a0f2b);color:var(--ink)}#app{display:grid;height:100%;gap:10px;padding:10px;grid-template-rows:64px 1fr 46px;grid-template-columns:360px 1fr 420px;grid-template-areas:"top top top" "left center right" "bottom bottom bottom"}header{grid-area:top;background:linear-gradient(90deg,#141834,#10153a);border:1px solid #21265a;border-radius:14px;display:flex;align-items:center;gap:10px;padding:8px 12px}header .logo{display:flex;align-items:center;gap:10px;font-weight:700}header .logo .dot{width:12px;height:12px;border-radius:50%;background:radial-gradient(30% 30% at 30% 30%,var(--brand2),var(--brand));box-shadow:0 0 12px var(--brand2)}header .q{flex:1;display:flex;gap:8px;align-items:center}input[type=text],textarea,select{background:#0e1330;border:1px solid #26306d;color:var(--ink);border-radius:12px;padding:10px}input[type=text]{width:100%}button{background:linear-gradient(180deg,#2a4bea,#2233aa);border:1px solid #2335b9;color:#fff;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}button[disabled]{opacity:.5;cursor:not-allowed}button.secondary{background:#181d43;border:1px solid #2a336d}button.ghost{background:transparent;border:1px dashed #2a336d}aside{background:linear-gradient(180deg,#13173a,#12163b);border:1px solid #21265a;border-radius:14px;padding:10px}#left{grid-area:left}#center{grid-area:center;background:radial-gradient(800px 600px at 50% 30%,rgba(142,162,255,.12),transparent 60%),linear-gradient(180deg,#0f132e,#0b0f28);border:1px solid #21265a;border-radius:14px;position:relative;overflow:hidden}#right{grid-area:right}#bottom{grid-area:bottom;background:linear-gradient(90deg,#141834,#10153a);border:1px solid #21265a;border-radius:14px;display:flex;align-items:center;gap:12px;padding:6px}h3{margin:8px 0 6px;font-size:13px;text-transform:uppercase;letter-spacing:.12em;color:#c8ccff}.panel{background:var(--panel);border:1px solid #21265a;border-radius:12px;padding:10px;margin-bottom:10px}.hint{font-size:12px;color:var(--muted)}.row{display:flex;gap:8px;align-items:center}.wrap{flex-wrap:wrap}.item{padding:8px;border:1px solid #262d61;border-radius:10px;background:#121641}.tiny{font-size:11px;color:var(--muted)}.right-tabs{display:flex;gap:6px;margin-bottom:8px}.right-tabs button{flex:1}.tabpage{display:none}.tabpage.active{display:block}#graph{position:absolute;inset:0}#graph svg{width:100%;height:100%;display:block}.node text{font-size:12px;fill:#eaf0ff;paint-order:stroke;stroke:#0b0f28;stroke-width:3px;stroke-linejoin:round}.edge{stroke:var(--edge);stroke-width:1.2;opacity:.78}.edge.strong{stroke-width:2.4}.edge.conflict{stroke:var(--bad);stroke-dasharray:3 2}.legend{position:absolute;top:8px;right:8px;background:#0d1232cc;border:1px solid #222a65;border-radius:10px;padding:6px 8px;font-size:12px}.legend i{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle}.legend .topic{background:#8ea2ff}.legend .claim{background:#20d497}.legend .source{background:#ffbd4a}.ctx{position:fixed;z-index:60;background:#0e1330;border:1px solid #2a356d;border-radius:10px;min-width:220px;box-shadow:0 12px 40px rgba(0,0,0,.45);display:none}.ctx .h{padding:10px 12px;border-bottom:1px solid #26306a;font-weight:600;color:#cfe1ff}.ctx button{display:block;width:100%;text-align:left;background:transparent;border:none;color:#e6ebff;padding:10px 12px;cursor:pointer}.ctx button:hover{background:#172054}.modal{position:fixed;inset:0;background:#0008;display:flex;align-items:center;justify-content:center;z-index:70}.modal .box{max-width:900px;width:92%;max-height:80%;overflow:auto;background:#0f1436;border:1px solid #2b3371;border-radius:12px;padding:12px}.tag{padding:6px 8px;border:1px solid #2a336d;border-radius:12px;background:#0f1440;font-size:12px;cursor:pointer}.tag.active{outline:1px solid #7ef0ff;background:#0f194f}#empty{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:30}#empty .card{max-width:540px;background:#0f1436dd;border:1px solid #2b3371;border-radius:14px;padding:16px}#tip{position:fixed;pointer-events:none;z-index:80;background:#0f1436;border:1px solid #2b3371;border-radius:8px;padding:6px 8px;font-size:12px;display:none}.pill{background:#181d43;border:1px solid #2a336d;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}</style></head><body><div id="app"><header><div class="logo"><span class="dot"></span> Qwello KG Core Lite v2.5</div><div class="q"><input id="question" type="text" placeholder="Ask about the loaded documents"/><button id="askBtn" title="Add a source to enable" disabled>Ask</button><div id="presetBar" class="row wrap" style="gap:6px;margin-left:8px"><span class="pill" data-q="Why is this important?">Why</span><span class="pill" data-q="What are the key claims and evidence?">Claims</span><span class="pill" data-q="What could contradict this?">Counter</span><span class="pill" data-q="What depends on this?">Dependencies</span></div></div><div class="row" style="min-width:420px;justify-content:flex-end;gap:8px"><label class="tiny">Layout</label><select id="layoutMode"><option value="force">Force</option><option value="radial">Radial</option></select><label class="tiny">Heatmap</label><input type="checkbox" id="heatmapToggle"/><button class="secondary" id="fitBtn">Fit</button><label class="tiny" style="margin-left:6px"><input type="checkbox" id="autoFit" checked/> Auto fit</label><span class="tiny" style="margin-left:10px">Conf</span><div style="height:8px;width:110px;border:1px solid #2b3371;border-radius:12px;overflow:hidden;background:#12163b"><i id="confFill" style="display:block;height:100%;width:0;background:linear-gradient(90deg,#7ef0ff,#8ea2ff)"></i></div><span id="confLabel" class="tiny">0.00</span></div></header><aside id="left"><h3>Sources</h3><div class="panel"><div class="row wrap" style="gap:6px"><input type="file" id="filePicker" multiple accept=".txt,.md,.json,.pdf"/><button class="ghost" id="clearAllBtn">Clear All</button><button class="ghost" id="demoBtn">Demo corpus</button></div><div class="tiny" id="srcCount">0 sources loaded</div><div class="hint">Upload txt, md, json, or pdf. If the PDF is image only or encoded, the preview below will warn you.</div></div><details open><summary>Add text as a source</summary><div class="hint">Paste any text here. Give it a title. Click Add.</div><div class="row" style="gap:6px;margin:6px 0 4px"><input id="pasteTitle" type="text" placeholder="Title (optional)"/><button id="addPaste" class="secondary">Add</button></div><textarea id="pasteArea" rows="8" style="width:100%" placeholder="Paste text here"></textarea></details><div class="panel"><h3 style="margin:0 0 6px">Lens</h3><div id="lensBar" class="row wrap"></div><div class="row" style="margin-top:8px;gap:10px;align-items:center"><label class="tiny"><input type="checkbox" id="crossClusterOnly"/> Cross cluster only</label><label class="tiny"><input type="checkbox" id="hubGlow"/> Highlight hubs</label><button id="resetBtn" class="ghost" style="margin-left:auto">Reset</button></div></div><div class="panel"><h3 style="margin:0 0 6px">Focus</h3><div class="hint">Right click a node → Focus here. Use k‑hop to widen.</div><div class="row"><label class="tiny">k‑hop</label><input type="range" id="kHop" min="1" max="3" step="1" value="2"/><button id="clearFocus" class="ghost">Clear</button></div><div id="focusInfo" class="tiny" style="margin-top:6px;color:#cfe1ff">No focus set.</div></div><div class="panel" id="sourcesPanel"><h3 style="margin-top:0">Loaded</h3><div id="sourcesList"></div></div><div class="panel"><h3 style="margin-top:0">PDF parse summary</h3><div id="pdfLog" class="tiny">No PDF parsed yet.</div></div></aside><main id="center"><div id="graph"></div><div id="empty"><div class="card"><div style="display:flex;justify-content:space-between;align-items:center"><strong>No nodes to show yet</strong><button id="emptyDemo" class="secondary">Load demo</button></div><div class="tiny" style="margin-top:6px">Add a source and click <b>Ask</b>, or load a demo corpus.</div></div></div><div class="legend"><div><i class="topic"></i> Topic</div><div><i class="claim"></i> Claim</div><div><i class="source"></i> Source</div></div></main><aside id="right"><h3>Insights</h3><div class="right-tabs"><button class="secondary" data-tab="findings">Findings</button><button class="secondary" data-tab="evidence">Evidence</button><button class="secondary" data-tab="sources">Sources</button><button class="secondary" data-tab="diag">Diag</button></div><div id="tab-findings" class="tabpage active"><div class="panel" id="answerPanel"><div><strong>Answer</strong></div><div id="answerText" class="tiny" style="margin-top:6px">Upload or paste text, then ask a question.</div></div><div class="panel" id="findingsList"></div></div><div id="tab-evidence" class="tabpage"><div class="panel" id="evidenceList"></div></div><div id="tab-sources" class="tabpage"><div class="panel" id="sourcesListRight"></div></div><div id="tab-diag" class="tabpage"><div class="panel"><div class="row"><strong>Event log</strong><button class="ghost" id="clearLog">Clear</button></div><div id="log">No events yet.</div></div><div class="panel" id="testsPanel"><div class="row" style="justify-content:space-between"><strong>Self tests</strong><button class="ghost" id="runTestsBtn">Run</button></div><div id="testsOut" class="tiny">No tests run yet.</div></div></div></aside><footer id="bottom"><label class="tiny">Min edge weight</label><input type="range" id="minWeight" min="0" max="1" step=".05" value="0"/><label class="tiny">Min insight score</label><input type="range" id="minInsight" min="0" max="1" step=".05" value="0"/><label class="tiny" style="margin-left:8px">Live layout</label><input type="checkbox" id="physicsToggle" checked/><div class="tiny" style="margin-left:auto">Right‑click a node for actions. Click a claim to see evidence. Scroll to zoom. Drag to pan. Press Enter to Ask.</div></footer></div><div id="toast" style="position:fixed;right:10px;bottom:10px;background:#111539;border:1px solid #27306a;border-radius:10px;padding:10px 12px;font-size:12px;color:#dfe4ff;min-width:220px;display:none;z-index:50"></div><div id="ctx" class="ctx"><div class="h">Node actions</div><div id="ctxBtns"></div></div><div id="tip"></div><script>const UI={q:id('question'),askBtn:id('askBtn'),filePicker:id('filePicker'),clearAllBtn:id('clearAllBtn'),demoBtn:id('demoBtn'),pasteTitle:id('pasteTitle'),addPaste:id('addPaste'),pasteArea:id('pasteArea'),lensBar:id('lensBar'),crossClusterOnly:id('crossClusterOnly'),hubGlow:id('hubGlow'),resetBtn:id('resetBtn'),sourcesList:id('sourcesList'),sourcesListRight:id('sourcesListRight'),srcCount:id('srcCount'),pdfLog:id('pdfLog'),minWeight:id('minWeight'),minInsight:id('minInsight'),physicsToggle:id('physicsToggle'),answerText:id('answerText'),findingsList:id('findingsList'),evidenceList:id('evidenceList'),confFill:id('confFill'),confLabel:id('confLabel'),empty:id('empty'),emptyDemo:id('emptyDemo'),toast:id('toast'),ctx:id('ctx'),ctxBtns:id('ctxBtns'),tabs:qsa('[data-tab]'),pages:{findings:id('tab-findings'),evidence:id('tab-evidence'),sources:id('tab-sources'),diag:id('tab-diag')},logBox:id('log'),clearLog:id('clearLog'),fitBtn:id('fitBtn'),autoFit:id('autoFit'),layoutMode:id('layoutMode'),heatmapToggle:id('heatmapToggle'),kHop:id('kHop'),clearFocus:id('clearFocus'),focusInfo:id('focusInfo'),presetBar:id('presetBar'),testsOut:id('testsOut'),runTestsBtn:id('runTestsBtn')};const state={sources:[],kg:null,layout:{nodes:new Map(),edges:[]},clusters:new Map(),clusterCollapsed:new Set(),hubScores:new Map(),counter:1,questionNodeId:null,focus:{nodeId:null,k:2}};function id(x){return document.getElementById(x)}function qsa(s,el=document){return Array.from(el.querySelectorAll(s))}function uid(p){return(p||'n')+(state.counter++)}function clamp(x,a,b){return Math.max(a,Math.min(b,x))}function esc(s){return(s+'').replace(/[&<>\"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]))}function log(msg){UI.logBox.textContent='['+new Date().toLocaleTimeString()+'] '+msg+'\n'+UI.logBox.textContent}function toast(msg){UI.toast.textContent=msg;UI.toast.style.display='block';clearTimeout(window.__t);window.__t=setTimeout(()=>UI.toast.style.display='none',2200)}function updateAsk(){const n=state.sources.length;UI.askBtn.disabled=n===0;UI.askBtn.title=n===0?'Add a source to enable':'Analyze and build graph';UI.srcCount.textContent=n+(n===1?' source loaded':' sources loaded')}let svg,gWorld,gEdges,gNodes,anim;const cam={x:0,y:0,scale:1};function NS(t){return document.createElementNS('http://www.w3.org/2000/svg',t)}function initSvg(){const box=id('graph');box.innerHTML='';svg=NS('svg');svg.setAttribute('width',Math.max(1100,box.clientWidth||1100));svg.setAttribute('height',Math.max(680,box.clientHeight||680));gWorld=NS('g');gEdges=NS('g');gNodes=NS('g');gWorld.append(gEdges,gNodes);svg.appendChild(gWorld);box.appendChild(svg);applyCam();let pan=false,sx=0,sy=0;svg.addEventListener('pointerdown',e=>{if(e.button!==0)return;pan=true;sx=e.clientX;sy=e.clientY;svg.setPointerCapture(e.pointerId)});svg.addEventListener('pointermove',e=>{if(!pan)return;cam.x+=(e.clientX-sx);cam.y+=(e.clientY-sy);sx=e.clientX;sy=e.clientY;applyCam()});svg.addEventListener('pointerup',()=>pan=false);svg.addEventListener('wheel',e=>{e.preventDefault();const r=svg.getBoundingClientRect(),px=r.width/2,py=r.height/2,wx=(px-cam.x)/cam.scale,wy=(py-cam.y)/cam.scale,f=(e.deltaY<0?1.12:1/1.12);cam.scale=clamp(cam.scale*f,.25,2.4);cam.x=px-wx*cam.scale;cam.y=py-wy*cam.scale;applyCam()},{passive:false});svg.addEventListener('mousemove',edgeFisheye)}function applyCam(){gWorld.setAttribute('transform',`translate(${cam.x},${cam.y}) scale(${cam.scale})`)}function fitView(){const pts=Array.from(state.layout.nodes.values());if(!pts.length)return;const xs=pts.map(p=>p.x),ys=pts.map(p=>p.y),minX=Math.min(...xs),maxX=Math.max(...xs),minY=Math.min(...ys),maxY=Math.max(...ys),vw=svg.clientWidth||1100,vh=svg.clientHeight||680,bw=(maxX-minX)+160,bh=(maxY-minY)+160,s=clamp(Math.min(vw/bw,vh/bh),.3,2.2);cam.scale=s;cam.x=vw/2-(minX+maxX)/2*s;cam.y=vh/2-(minY+maxY)/2*s;applyCam()}function step(){const nodes=[...gNodes.querySelectorAll('g.node')],edges=[...gEdges.querySelectorAll('line')],P=new Map(nodes.map(n=>[n.dataset.id,state.layout.nodes.get(n.dataset.id)]));nodes.forEach(n=>{const p=P.get(n.dataset.id);p.vx=(p.vx||0)*0.88;p.vy=(p.vy||0)*0.88});const C={x:(svg.clientWidth||1100)/2,y:(svg.clientHeight||680)/2};nodes.forEach(n=>{const p=P.get(n.dataset.id);p.vx+=(C.x-p.x)*0.02;p.vy+=(C.y-p.y)*0.02});edges.forEach(e=>{const a=state.layout.nodes.get(e.dataset.source),b=state.layout.nodes.get(e.dataset.target);if(!a||!b)return;const dx=b.x-a.x,dy=b.y-a.y,d=Math.hypot(dx,dy)+1e-6,desired=110,f=(d-desired)*0.02,fx=f*dx/d,fy=f*dy/d;a.vx+=fx;a.vy+=fy;b.vx-=fx;b.vy-=fy});for(let i=0;i<nodes.length;i++)for(let j=i+1;j<nodes.length;j++){const a=state.layout.nodes.get(nodes[i].dataset.id),b=state.layout.nodes.get(nodes[j].dataset.id),dx=b.x-a.x,dy=b.y-a.y,d2=dx*dx+dy*dy+0.01,f=900/d2;a.vx-=f*dx;b.vx+=f*dx;a.vy-=f*dy;b.vy+=f*dy}nodes.forEach(n=>{const p=P.get(n.dataset.id);p.x+=p.vx;p.y+=p.vy});renderPositions();anim=requestAnimationFrame(step)}function renderPositions(){const nodes=[...gNodes.querySelectorAll('g.node')],edges=[...gEdges.querySelectorAll('line')];nodes.forEach(n=>{const p=state.layout.nodes.get(n.dataset.id);n.setAttribute('transform',`translate(${p.x},${p.y})`)});edges.forEach(e=>{const a=state.layout.nodes.get(e.dataset.source),b=state.layout.nodes.get(e.dataset.target);if(!a||!b)return;e.setAttribute('x1',a.x);e.setAttribute('y1',a.y);e.setAttribute('x2',b.x);e.setAttribute('y2',b.y)})}const LENSES=[{key:'topic',label:'Topics'},{key:'claim',label:'Claims'},{key:'source',label:'Sources'}];let activeLenses=new Set(LENSES.map(l=>l.key));function renderLensBar(){UI.lensBar.innerHTML='';LENSES.forEach(l=>{const b=document.createElement('button');b.className='tag '+(activeLenses.has(l.key)?'active':'');b.textContent=l.label;b.onclick=()=>{activeLenses.has(l.key)?activeLenses.delete(l.key):activeLenses.add(l.key);b.classList.toggle('active');drawGraph()};UI.lensBar.appendChild(b)})}renderLensBar();function resetFilters(){activeLenses=new Set(LENSES.map(l=>l.key));renderLensBar();UI.crossClusterOnly.checked=false;UI.hubGlow.checked=false;UI.minWeight.value=0;UI.minInsight.value=0;state.clusterCollapsed.clear();state.focus.nodeId=null;UI.focusInfo.textContent='No focus set.';toast('Filters reset')}const ORD={"1st":"first","2nd":"second","3rd":"third","4th":"fourth","5th":"fifth","6th":"sixth","7th":"seventh","8th":"eighth","9th":"ninth","10th":"tenth"};function normalizeToken(t){return ORD[t]||t}function splitSentences(t){if(!t)return[];let s=String(t);['•','●','∙','-'].forEach(ch=>s=s.split(ch).join('. '));s=s.replace(/\r/g,' ').replace(/\n/g,' ').replace(/\s{2,}/g,' ');const out=[];let buf='';for(let i=0;i<s.length;i++){const ch=s[i];buf+=ch;if(ch==='.'||ch==='!'||ch==='?'){const next=s[i+1];if(!next||next===' '){const trimmed=buf.trim();if(trimmed.length>8)out.push(trimmed);buf='';}}}if(buf.trim().length>8)out.push(buf.trim());return out}function tokenize(t){const s=(t||'').toLowerCase();const m=s.match(/[A-Za-z0-9][A-Za-z0-9_-]*/g);return m||[]}function uniq(a){return Array.from(new Set(a))}function synthPages(text){const size=1800,overlap=180;const pages=[];for(let i=0;i<text.length;i+=size-overlap)pages.push({index:pages.length+1,text:text.slice(i,i+size)});return pages}function addSourceFromText(filename,content){const pages=synthPages(content);qualityLog(filename,content);state.sources.push({source_id:uid('src'),title:filename.replace(/\.[^.]+$/,''),filename,url:'',created_at:new Date().toISOString().slice(0,10),text:content,pages});renderSources();updateAsk()}async function onPickFiles(e){const files=[...e.target.files||[]];for(const f of files){try{if(/\.pdf$/i.test(f.name)){log('PDF upload: '+f.name);const t0=performance.now();const pages=await extractPdfLight(f);const sid=uid('src');const text=pages.map(p=>'[Page '+p.index+']\n'+p.text).join('\n\n');qualityLog(f.name,text);state.sources.push({source_id:sid,title:f.name.replace(/\.[^.]+$/,''),filename:f.name,url:'',created_at:new Date().toISOString().slice(0,10),text,pages});UI.pdfLog.innerHTML='<div>Parsed <strong>'+esc(f.name)+'</strong>: '+pages.length+' pages, '+text.length.toLocaleString()+' chars in '+(performance.now()-t0).toFixed(0)+' ms.</div>';toast('PDF parsed: '+pages.length+' pages')}else{addSourceFromText(f.name,await f.text());toast('Loaded '+f.name)}}catch(err){log('onPickFiles error: '+(err&&err.message||err))}}updateAsk()}function qualityLog(name,text){const q=pdfQuality(text);const msg='Preview '+esc(name)+': ASCII '+Math.round(q.ascii*100)+'%, words '+q.words+', avgLen '+q.avg.toFixed(1)+', vowels '+Math.round(q.vowel*100)+'%';UI.pdfLog.innerHTML='<div>'+msg+(q.ascii<.65?' <span style="color:#ffbd4a">(possible encoded text — consider pasting text or using a selectable PDF)</span>':'')+'</div>'+UI.pdfLog.innerHTML;log(msg)}function pdfQuality(t){const sample=(t||'').slice(0,4000);const ascii=[...sample].filter(c=>c>=' '&&c<='~').length/(sample.length||1);const words=(sample.match(/[A-Za-z]{2,}/g)||[]);const avg=words.join(' ').length/((words.length||1));const vowel=(sample.match(/[aeiouAEIOU]/g)||[]).length/((sample.match(/[A-Za-z]/g)||[]).length||1);return {ascii,words:words.length,avg,vowel}}async function extractPdfLight(file){const buf=await file.arrayBuffer();const bytes=new Uint8Array(buf);const str=new TextDecoder('latin1').decode(bytes);const raw=str.split(/\n\s*\/Type\s*\/Page\b/g);const pages=[];for(let i=1;i<raw.length;i++){const seg=raw[i];const parts=[];const lit=/\((?:\\\)|\\\(|\\\\|[^\)])*\)\s*(?:Tj|TJ)/g;const hex=/<([0-9A-Fa-f\s]+)>\s*(?:Tj|TJ)/g;let m;while((m=lit.exec(seg)))parts.push(unescapePdf(m[0]));while((m=hex.exec(seg)))parts.push(hexToString(m[1]));const txt=cleanup(parts.join(' '));pages.push({index:i,text:txt})}if(!pages.length){const parts=[];const lit=/\((?:\\\)|\\\(|\\\\|[^\)])*\)\s*(?:Tj|TJ)/g;const hex=/<([0-9A-Fa-f\s]+)>\s*(?:Tj|TJ)/g;let m;while((m=lit.exec(str)))parts.push(unescapePdf(m[0]));while((m=hex.exec(str)))parts.push(hexToString(m[1]));return [{index:1,text:cleanup(parts.join(' '))}]}return pages}function unescapePdf(s){const inner=s.replace(/\)\s*(Tj|TJ)$/,'').replace(/^\(/,'').replace(/\)$/,'');return inner.replace(/\\([nrtbf\\()])/g,(m,c)=>({n:'\n',r:'\r',t:'\t',b:'\b',f:'\f','\\':'\\','(':'(',')':')'})[c]||c)}function hexToString(hex){try{const clean=hex.replace(/\s+/g,'');const bytes=clean.match(/.{1,2}/g)||[];return String.fromCharCode(...bytes.map(h=>parseInt(h,16)))}catch(e){return ''}}function cleanup(t){return t.replace(/\s{2,}/g,' ').replace(/\s+([,.;:!?])/g,'$1').trim()}function analyze(question){try{if(!question){toast('Type a question');return}if(!state.sources.length){toast('Add a source first');UI.empty.style.display='flex';return}const corpus=[];state.sources.forEach(s=>s.pages.forEach(p=>corpus.push({source_id:s.source_id,title:s.title,page:p.index,text:p.text})));
const docs=corpus.length,tf=new Map(),df=new Map();corpus.forEach(d=>{const toks=tokenize(d.text).map(normalizeToken),u=uniq(toks);u.forEach(t=>df.set(t,(df.get(t)||0)+1));toks.forEach(t=>tf.set(t,(tf.get(t)||0)+1))});const idf=t=>Math.log((docs+1)/((df.get(t)||1))),score=t=>(tf.get(t)||0)*idf(t);
const q=tokenize(question).map(normalizeToken),qSet=new Set(q),boosted=[...tf.keys()].sort((a,b)=>score(b)-score(a)).slice(0,20),topTerms=[...new Set(q.concat(boosted))].slice(0,24);
const sentScores=[];corpus.forEach(d=>{splitSentences(d.text).forEach(s=>{const toks=tokenize(s).map(normalizeToken);let sc=0;topTerms.forEach(t=>{if(toks.includes(t))sc+=(qSet.has(t)?3:1)});if(sc>0)sentScores.push({s:s.trim(),score:sc,source_id:d.source_id,title:d.title,page:d.page})})});sentScores.sort((a,b)=>b.score-a.score);
let topSents=sentScores.slice(0,22);
const nodes=[],edges=[],claims=[],evidence=[];const qNode={id:uid('n'),label:question,type:'topic'};state.questionNodeId=qNode.id;nodes.push(qNode);
// === Fallback path when no sentence hits ===
if(!topSents.length){log('No sentence hits. Using page-window fallback.'); const pageScores=corpus.map(d=>{const toks=tokenize(d.text),hits=q.filter(t=>toks.includes(t)).length;return {d,score:hits+(d.text.length>0?0.01:0)}}).sort((a,b)=>b.score-a.score).slice(0,3);
pageScores.forEach(ps=>{const d=ps.d;if(!d.text)return;const windows=getWindows(d.text,q,220);windows.slice(0,3).forEach(w=>{const cId=uid('c'),evId=uid('ev');claims.push({id:cId,text:w,stance:'neutral',strength:.35,source_ids:[d.source_id],evidence_ids:[evId],tags:[],score:.3});evidence.push({id:evId,source_id:d.source_id,page:d.page,quote:w});nodes.push({id:cId,label:w.slice(0,60)+'…',type:'claim'},{id:uid('n'),label:d.title,type:'source',source_id:d.source_id});edges.push({source:cId,target:nodes[nodes.length-1].id,type:'supported_by',weight:.4},{source:qNode.id,target:cId,type:'addresses',weight:.6})})}); if(!claims.length){ // last resort: show boosted terms
const termNodes=topTerms.slice(0,8).map(t=>({id:uid('n'),label:t,type:'topic'}));nodes.push(...termNodes);termNodes.forEach(n=>edges.push({source:qNode.id,target:n.id,type:'relates_to',weight:.5}))}
const conf=claims.length?0.35:0.05;state.kg={question,answer_summary:claims.slice(0,2).map(x=>x.text).join(' ')||'No direct textual match found. Likely PDF text is encoded. Try pasting text or another PDF.',confidence:conf,nodes,edges,claims,evidence,sources:compactSources(),contradictions:[],open_questions:[],metrics:{}};UI.answerText.textContent=state.kg.answer_summary;UI.confFill.style.width=(conf*100)+'%';UI.confLabel.textContent=conf.toFixed(2);computeClusters();computeHubScores();renderFindings();renderEvidence();drawGraph();if(UI.autoFit.checked)setTimeout(fitView,60);return}
// === Normal path ===
const termNodes=topTerms.slice(0,6).map(t=>({id:uid('n'),label:t,type:'topic'}));nodes.push(...termNodes);termNodes.forEach(n=>edges.push({source:qNode.id,target:n.id,type:'relates_to',weight:.6}));
topSents.forEach(ts=>{const cId=uid('c'),evId=uid('ev'),strength=clamp(ts.score/10,0,1);claims.push({id:cId,text:ts.s,stance:'neutral',strength,source_ids:[ts.source_id],evidence_ids:[evId],tags:[],score:0});evidence.push({id:evId,source_id:ts.source_id,page:ts.page,quote:ts.s.slice(0,220)});nodes.push({id:cId,label:ts.s.slice(0,60)+'…',type:'claim'},{id:uid('n'),label:ts.title,type:'source',source_id:ts.source_id});edges.push({source:cId,target:nodes[nodes.length-1].id,type:'supported_by',weight:strength},{source:qNode.id,target:cId,type:'addresses',weight:.7})});
claims.forEach(c=>{const toks=new Set(tokenize(c.text)),overlap=[...q].filter(t=>toks.has(t)).length,specificity=clamp(overlap/(qSet.size||1),0,1),strength=c.strength;c.score=0.55*strength+0.35*specificity+0.1});
const confidence=clamp(claims.reduce((a,x)=>a+x.score,0)/(claims.length||1),0,1);state.kg={question,answer_summary:topSents.slice(0,2).map(x=>x.s).join(' '),confidence,nodes,edges,claims,evidence,sources:compactSources(),contradictions:[],open_questions:[],metrics:{}};UI.confFill.style.width=(confidence*100).toFixed(0)+'%';UI.confLabel.textContent=confidence.toFixed(2);UI.answerText.textContent=state.kg.answer_summary;computeClusters();computeHubScores();renderFindings();renderEvidence();drawGraph();if(UI.autoFit.checked)setTimeout(fitView,60)}catch(err){log('analyze error: '+(err&&err.message||err));alert('Analyze failed: '+(err&&err.message||err))}}
function getWindows(text,terms,w=220){const low=text.toLowerCase();const idxs=[];terms.forEach(t=>{let i=0;while((i=low.indexOf(t,i))>-1){idxs.push(i);i+=t.length}});idxs.sort((a,b)=>a-b);const out=[];idxs.forEach(i=>{const a=Math.max(0,i-Math.floor(w/2)),b=Math.min(text.length,i+Math.floor(w/2));out.push(text.slice(a,b).replace(/\s+/g,' ').trim())});return out.length?uniq(out):splitSentences(text).slice(0,3)}
function compactSources(){return state.sources.map(s=>({source_id:s.source_id,title:s.title,filename:s.filename,url:s.url,created_at:s.created_at,pages:s.pages.map(p=>({index:p.index,char_count:(p.text||'').length}))}))}
function renderSources(){const L=UI.sourcesList,R=UI.sourcesListRight;L.innerHTML='';R.innerHTML='';state.sources.forEach(s=>{const d=document.createElement('div');d.className='item';d.innerHTML='<div class="row" style="justify-content:space-between"><div><div><strong>'+esc(s.title)+'</strong></div><div class="tiny">'+esc(s.filename)+' · '+s.pages.length+' pages</div></div><button type="button" class="xbtn" data-del="'+s.source_id+'">Delete</button></div>';L.appendChild(d);const d2=document.createElement('div');d2.className='item';d2.innerHTML='<div><div><strong>'+esc(s.title)+'</strong></div><div class="tiny">'+esc(s.filename)+' · '+s.pages.length+' pages</div></div>';R.appendChild(d2)});[...L.querySelectorAll('[data-del]')].forEach(btn=>btn.addEventListener('click',()=>{const sid=btn.getAttribute('data-del');state.sources=state.sources.filter(x=>x.source_id!==sid);renderSources();updateAsk();toast('Source removed')}))}
function renderFindings(){const kg=state.kg,box=UI.findingsList;if(!kg||!kg.claims){box.innerHTML='';return}const min=Number(UI.minInsight.value);const sorted=[...kg.claims].sort((a,b)=>b.score-a.score).filter(c=>c.score>=min);box.innerHTML=sorted.slice(0,18).map(c=>'<div class="item"><div>'+esc(c.text||'')+'</div><div class="tiny">score '+(c.score||0).toFixed(2)+'</div></div>').join('')}
function renderEvidence(){const kg=state.kg,box=UI.evidenceList;if(!kg){box.innerHTML='';return}box.innerHTML=(kg.evidence||[]).slice(0,20).map(ev=>{const s=(kg.sources||[]).find(z=>z.source_id===ev.source_id);const title=s?s.title:'Source';return '<div class="item"><div class="tiny">'+esc(title)+' · page '+ev.page+'</div><blockquote>“'+esc(ev.quote||'')+'”</blockquote></div>'}).join('')}
function computeClusters(){state.clusters.clear();state.clusterCollapsed.clear();const kg=state.kg;if(!kg)return;const nodes=kg.nodes.map(n=>({id:n.id,type:n.type,label:n.label,cluster:n.id})),edges=kg.edges.map(e=>({a:e.source,b:e.target,weight:e.weight||1}));for(let it=0;it<10;it++){let changed=0;nodes.forEach(n=>{const counts=new Map();edges.forEach(e=>{if(e.a===n.id||e.b===n.id){const nb=(e.a===n.id?e.b:e.a),c=nodes.find(x=>x.id===nb).cluster;counts.set(c,(counts.get(c)||0)+e.weight)}});let best=n.cluster,bw=-1;counts.forEach((w,c)=>{if(w>bw){bw=w;best=c}});if(best!==n.cluster){n.cluster=best;changed++}});if(changed===0)break}const map=new Map();nodes.forEach(n=>{(map.get(n.cluster)||map.set(n.cluster,[]).get(n.cluster)).push(n.id)});map.forEach((ids,cid)=>{state.clusters.set(cid,new Set(ids));if(ids.length>=6)state.clusterCollapsed.add(cid)})}
function computeHubScores(){state.hubScores.clear();if(!state.kg)return;const deg=new Map();state.kg.edges.forEach(e=>{deg.set(e.source,(deg.get(e.source)||0)+1);deg.set(e.target,(deg.get(e.target)||0)+1)});state.kg.nodes.forEach(n=>state.hubScores.set(n.id,deg.get(n.id)||0))}
function kHopSet(rootId,k){const nb=new Map();state.kg.edges.forEach(e=>{(nb.get(e.source)||nb.set(e.source,[]).get(e.source)).push(e.target);(nb.get(e.target)||nb.set(e.target,[]).get(e.target)).push(e.source)});const q=[rootId],dist=new Map([[rootId,0]]);while(q.length){const v=q.shift();for(const u of nb.get(v)||[]){if(!dist.has(u)){dist.set(u,dist.get(v)+1);if(dist.get(u)<=k)q.push(u)}}}const keep=new Set();dist.forEach((d,id)=>{if(d<=k)keep.add(id)});return keep}
function radialPositions(centerId){const pos=new Map(),kg=state.kg;if(!kg)return pos;const nb=new Map();kg.edges.forEach(e=>{(nb.get(e.source)||nb.set(e.source,[]).get(e.source)).push(e.target);(nb.get(e.target)||nb.set(e.target,[]).get(e.target)).push(e.source)});const dist=new Map([[centerId,0]]),q=[centerId];while(q.length){const v=q.shift();for(const u of nb.get(v)||[]){if(!dist.has(u)){dist.set(u,dist.get(v)+1);q.push(u)}}}const rings=new Map();dist.forEach((d,id)=>{(rings.get(d)||rings.set(d,[]).get(d)).push(id)});const cx=(svg.clientWidth||1100)/2,cy=(svg.clientHeight||680)/2,rStep=140;rings.forEach((ids,d)=>{const r=d*rStep,n=ids.length||1;ids.forEach((id,i)=>{const a=2*Math.PI*(i/n)+(d%2?Math.PI/n:0);pos.set(id,{x:cx+Math.cos(a)*r,y:cy+Math.sin(a)*r,vx:0,vy:0})})});return pos}
function drawGraph(){initSvg();if(!state.kg){UI.empty.style.display='flex';return}const kg=state.kg,minW=Number(UI.minWeight.value);let nodes=kg.nodes||[];let edges=(kg.edges||[]).filter(e=>e.weight==null||e.weight>=minW);let visibleIds=new Set(nodes.map(n=>n.id));if(state.focus.nodeId){visibleIds=kHopSet(state.focus.nodeId,state.focus.k)}const lens=new Set(activeLenses);nodes=nodes.filter(n=>lens.has(n.type)&&visibleIds.has(n.id));edges=edges.filter(e=>visibleIds.has(e.source)&&visibleIds.has(e.target));if(UI.layoutMode.value==='radial'){const center=state.focus.nodeId||state.questionNodeId||(kg.nodes.find(n=>n.type==='topic')||{}).id;const pos=radialPositions(center);nodes.forEach((n,i)=>{const p=pos.get(n.id)||{x:(svg.clientWidth||1100)/2+Math.cos(i)*160,y:(svg.clientHeight||680)/2+Math.sin(i)*160,vx:0,vy:0};state.layout.nodes.set(n.id,p)});UI.physicsToggle.checked=false}else{nodes.forEach((n,i)=>{if(!state.layout.nodes.has(n.id))state.layout.nodes.set(n.id,{x:(svg.clientWidth||1100)/2+Math.cos(i)*140,y:(svg.clientHeight||680)/2+Math.sin(i)*140,vx:0,vy:0})})}state.layout.edges=edges;gEdges.innerHTML='';edges.forEach(e=>{const line=NS('line');line.classList.add('edge');if(e.type==='contradicts')line.classList.add('conflict');if((e.weight||0)>0.8)line.classList.add('strong');line.dataset.source=e.source;line.dataset.target=e.target;line.dataset.type=e.type||'rel';line.dataset.weight=(e.weight||0).toFixed(2);line.addEventListener('mousemove',showEdgeTip);line.addEventListener('mouseleave',hideTip);gEdges.appendChild(line)});gNodes.innerHTML='';nodes.forEach(n=>{const g=NS('g');g.classList.add('node');g.dataset.id=n.id;g.addEventListener('contextmenu',ev=>openCtx(ev,n));g.addEventListener('click',()=>{if(n.type==='claim')openEvidence(n)});const isClaim=n.type==='claim',isSource=n.type==='source',isTopic=n.type==='topic',r=isClaim?14:isSource?12:10;let fill=isClaim?'#173b35':isSource?'#3a2d13':isTopic?'#161d55':'#102b3b';let stroke=isClaim?'#20d497':isSource?'#ffbd4a':isTopic?'#8ea2ff':'#7ef0ff';if(UI.heatmapToggle.checked&&isClaim){const c=kg.claims.find(c=>c.id===n.id),sc=(c&&c.score)||0,light=35+Math.round(40*sc);fill=`hsl(160,45%,${light}%)`;stroke='#0d2f28'}const c=NS('circle');c.setAttribute('r',r);c.setAttribute('fill',fill);c.setAttribute('stroke',stroke);if(UI.hubGlow.checked&&(state.hubScores.get(n.id)||0)>=hubThreshold())c.style.filter='drop-shadow(0 0 8px rgba(126,240,255,.45))';const t=NS('text');t.setAttribute('text-anchor','middle');t.setAttribute('dy','.35em');t.textContent=n.label;g.append(c,t);enableDrag(g);gNodes.appendChild(g)});if(UI.physicsToggle.checked&&UI.layoutMode.value==='force'){cancelAnimationFrame(anim);step()}else{renderPositions()}if(UI.autoFit.checked)setTimeout(fitView,10);UI.empty.style.display=(gNodes.childElementCount===0?'flex':'none')}
function hubThreshold(){const v=[...state.hubScores.values()];if(!v.length)return Infinity;v.sort((a,b)=>a-b);return v[Math.floor(v.length*0.95)]||Infinity}
function showEdgeTip(e){const tip=id('tip');const t=e.target;tip.textContent=(t.dataset.type||'rel')+' · w='+t.dataset.weight;tip.style.left=(e.clientX+8)+'px';tip.style.top=(e.clientY+8)+'px';tip.style.display='block'}function hideTip(){id('tip').style.display='none'}function edgeFisheye(e){}
function enableDrag(g){let dragging=false,sx=0,sy=0;g.addEventListener('pointerdown',ev=>{if(ev.button!==0)return;dragging=true;sx=ev.clientX;sy=ev.clientY;g.setPointerCapture(ev.pointerId)});g.addEventListener('pointermove',ev=>{if(!dragging)return;const p=state.layout.nodes.get(g.dataset.id);p.x+=(ev.clientX-sx)/cam.scale;p.y+=(ev.clientY-sy)/cam.scale;sx=ev.clientX;sy=ev.clientY;renderPositions()});g.addEventListener('pointerup',()=>dragging=false)}
function openCtx(ev,node){ev.preventDefault();UI.ctxBtns.innerHTML='';const menu=UI.ctx;const add=(label,fn)=>{const b=document.createElement('button');b.textContent=label;b.onclick=()=>{menu.style.display='none';fn()};UI.ctxBtns.appendChild(b)};add('Expand around "'+node.label.slice(0,30)+'"',()=>expandAround(node));add('Summarize this',()=>summarizeNode(node));add('Find counterevidence',()=>counterNode(node));add('Shortest path to question',()=>pathToQuestion(node));add('Focus here',()=>{state.focus.nodeId=node.id;UI.focusInfo.textContent='Focus on: '+node.label.slice(0,40);drawGraph();if(UI.autoFit.checked)setTimeout(fitView,40)});menu.style.left=ev.clientX+'px';menu.style.top=ev.clientY+'px';menu.style.display='block';document.addEventListener('click',()=>menu.style.display='none',{once:true})}
function expandAround(node){if(!state.kg)return;const terms=uniq(tokenize(node.label).map(normalizeToken)).filter(x=>x.length>2);if(!terms.length)return toast('Nothing to expand');const matches=[];state.sources.forEach(s=>s.pages.forEach(p=>splitSentences(p.text).forEach(sen=>{const toks=tokenize(sen).map(normalizeToken);let hit=0;terms.forEach(t=>{if(toks.includes(t))hit++});if(hit>=Math.min(2,terms.length))matches.push({sen,source_id:s.source_id,title:s.title,page:p.index,score:hit})})));matches.sort((a,b)=>b.score-a.score);const pick=matches.slice(0,8);const around=state.layout.nodes.get(node.id)||{x:0,y:0};let ang=0,step=(Math.PI*2)/(pick.length||1);pick.forEach(m=>{const cId=uid('c'),evId=uid('ev');state.kg.claims.push({id:cId,text:m.sen,stance:'neutral',strength:clamp(m.score/5,0,1),source_ids:[m.source_id],evidence_ids:[evId],tags:[],score:0.3});state.kg.evidence.push({id:evId,source_id:m.source_id,page:m.page,quote:m.sen.slice(0,220)});state.kg.nodes.push({id:cId,label:m.sen.slice(0,60)+'…',type:'claim'});const src={id:uid('n'),label:m.title,type:'source',source_id:m.source_id};state.kg.nodes.push(src);state.kg.edges.push({source:cId,target:src.id,type:'supported_by',weight:0.5},{source:node.id,target:cId,type:'relates_to',weight:0.7});const r=140+Math.random()*40;state.layout.nodes.set(cId,{x:around.x+Math.cos(ang)*r,y:around.y+Math.sin(ang)*r,vx:0,vy:0});ang+=step});computeClusters();computeHubScores();renderFindings();renderEvidence();drawGraph();if(UI.autoFit.checked)setTimeout(fitView,30)}
function summarizeNode(node){if(!state.kg)return;const terms=uniq(tokenize(node.label).map(normalizeToken));const pool=[];state.sources.forEach(s=>s.pages.forEach(p=>splitSentences(p.text).forEach(sen=>{const toks=tokenize(sen).map(normalizeToken);const hit=terms.filter(t=>toks.includes(t)).length;if(hit>0)pool.push({sen,hit})})));pool.sort((a,b)=>b.hit-a.hit);const summary=pool.slice(0,6).map(x=>'• '+x.sen).join('\n');showModal('<h3>Summary</h3><pre>'+esc(summary||'No matching text found')+'</pre>')}
function counterNode(node){if(!state.kg)return;const neg=['however','but','not ','lacks','fails','concern','limitation','risk','problem'];const terms=uniq(tokenize(node.label).map(normalizeToken));const hits=[];state.sources.forEach(s=>s.pages.forEach(p=>splitSentences(p.text).forEach(sen=>{const low=sen.toLowerCase();if(!neg.some(n=>low.includes(n)))return;const toks=tokenize(sen).map(normalizeToken);if(terms.some(t=>toks.includes(t)))hits.push({sen,source_id:s.source_id,title:s.title,page:p.index})})));if(!hits.length)return toast('No obvious counterevidence found');hits.slice(0,4).forEach(h=>{const cId=uid('c'),evId=uid('ev');state.kg.claims.push({id:cId,text:h.sen,stance:'contra',strength:0.4,source_ids:[h.source_id],evidence_ids:[evId],tags:['counter'],score:0.35});state.kg.evidence.push({id:evId,source_id:h.source_id,page:h.page,quote:h.sen.slice(0,220)});state.kg.nodes.push({id:cId,label:h.sen.slice(0,60)+'…',type:'claim'});const src={id:uid('n'),label:h.title,type:'source',source_id:h.source_id};state.kg.nodes.push(src);state.kg.edges.push({source:cId,target:src.id,type:'supported_by',weight:0.4},{source:node.id,target:cId,type:'contradicts',weight:0.8});const p=state.layout.nodes.get(node.id)||{x:0,y:0};state.layout.nodes.set(cId,{x:p.x+120,y:p.y+60,vx:0,vy:0})});computeClusters();computeHubScores();renderFindings();renderEvidence();drawGraph();if(UI.autoFit.checked)setTimeout(fitView,30)}
function pathToQuestion(node){if(!state.kg)return;const start=node.id;let goal=state.questionNodeId||(state.kg.nodes.find?state.kg.nodes.find(n=>n.type==='topic'):null);goal=goal?goal.id:null;const nb=new Map();state.kg.edges.forEach(e=>{(nb.get(e.source)||nb.set(e.source,[]).get(e.source)).push(e.target);(nb.get(e.target)||nb.set(e.target,[]).get(e.target)).push(e.source)});const q=[[start]],seen=new Set([start]);let found=null;while(q.length){const path=q.shift();const last=path[path.length-1];if(last===goal){found=path;break}(nb.get(last)||[]).forEach(x=>{if(!seen.has(x)){seen.add(x);q.push(path.concat([x]))}})}if(!found)re
